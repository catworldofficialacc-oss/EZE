#!/bin/bash
# Ez Installer: eze0.1.0
# Fully rewritten, polished version
# Features:
#   - Install/update/remove modules
#   - Safe self-update with slow download
#   - Module-aware: installs only requested modules
#   - Friendly terminal messages
#   - No default installs

# -------------------------------
# Paths
# -------------------------------
EZ_ROOT="$HOME/ez_runtime"
MODULES_DIR="$EZ_ROOT/modules"
EZE_PATH="$EZ_ROOT/eze"

mkdir -p "$MODULES_DIR"

# -------------------------------
# Map modules to download URLs
# -------------------------------
declare -A MODULE_URLS
MODULE_URLS["Keys"]="https://raw.githubusercontent.com/catworldofficialacc-oss/EZK/refs/heads/main/Keys0.2.0
"
# You can add more modules later:
# MODULE_URLS["OtherModule"]="https://raw.githubusercontent.com/user/OtherRepo/main/OtherModuleFile"

# -------------------------------
# Arguments
# -------------------------------
MODULE="$1"
ACTION="$2"

# -------------------------------
# Slow download function
# -------------------------------
function slow_download() {
    local url="$1"
    local dest="$2"

    temp_file=$(mktemp)
    # Download silently
    if command -v curl &>/dev/null; then
        curl -s -o "$temp_file" "$url"
    elif command -v wget &>/dev/null; then
        wget -q -O "$temp_file" "$url"
    else
        echo "Error: curl or wget not installed"
        exit 1
    fi

    # Slow line-by-line write
    mkdir -p "$(dirname "$dest")"
    > "$dest"
    echo "Downloading $dest..."
    while IFS= read -r line; do
        echo "$line" >> "$dest"
        sleep 0.03
    done < "$temp_file"

    rm "$temp_file"
    echo "Download complete ✅"
}

# -------------------------------
# Self-update logic
# -------------------------------
if [[ "$MODULE" == "update_eze" ]]; then
    echo "Updating eze script..."

    EZE_RAW_URL="https://raw.githubusercontent.com/catworldofficialacc-oss/EZE/refs/heads/main/eze0.1.0"

    temp_file=$(mktemp)

    if command -v curl &>/dev/null; then
        curl -s -o "$temp_file" "$EZE_RAW_URL"
    elif command -v wget &>/dev/null; then
        wget -q -O "$temp_file" "$EZE_RAW_URL"
    else
        echo "Error: curl or wget not installed"
        exit 1
    fi

    # Slow line-by-line
    temp_file_slow="${temp_file}.slow"
    > "$temp_file_slow"
    echo "Downloading eze line by line..."
    while IFS= read -r line; do
        echo "$line" >> "$temp_file_slow"
        sleep 0.03
    done < "$temp_file"

    # Replace safely
    if [[ -w "$EZE_PATH" ]]; then
        mv "$temp_file_slow" "$EZE_PATH"
        chmod +x "$EZE_PATH"
        rm -f "$temp_file"
        echo "eze updated successfully ✅"
    else
        echo "Error: cannot overwrite $EZE_PATH. Check permissions."
        rm -f "$temp_file" "$temp_file_slow"
        exit 1
    fi

    exit 0
fi

# -------------------------------
# Show usage / list modules if no module specified
# -------------------------------
if [[ -z "$MODULE" ]]; then
    echo "Ez Installer (eze0.1.0)"
    echo "Available modules to install:"
    for mod in "${!MODULE_URLS[@]}"; do
        echo "  - $mod"
    done
    echo ""
    echo "Usage: eze <ModuleName> [update|remove]"
    echo "       eze update_eze   # self-update eze"
    exit 0
fi

# -------------------------------
# Check if module exists
# -------------------------------
GITHUB_RAW="${MODULE_URLS[$MODULE]}"
if [[ -z "$GITHUB_RAW" ]]; then
    echo "Error: Unknown module '$MODULE'. Available modules: ${!MODULE_URLS[@]}"
    exit 1
fi

# -------------------------------
# Module folder
# -------------------------------
module_path="$MODULES_DIR/$MODULE"

# -------------------------------
# Handle remove
# -------------------------------
if [[ "$ACTION" == "remove" ]]; then
    if [[ ! -d "$module_path" ]]; then
        echo "Module '$MODULE' is not installed."
        exit 1
    fi
    rm -rf "$module_path"
    echo "Module '$MODULE' removed successfully ❌"
    exit 0
fi

# -------------------------------
# Handle update
# -------------------------------
if [[ "$ACTION" == "update" ]]; then
    if [[ ! -d "$module_path" ]]; then
        echo "Module '$MODULE' is not installed. Run 'eze $MODULE' to install it first."
        exit 1
    fi
    rm -f "$module_path"/*
    mkdir -p "$module_path"
fi

# -------------------------------
# Default: install
# -------------------------------
if [[ "$ACTION" != "update" ]]; then
    if [[ -d "$module_path" && "$ACTION" != "" ]]; then
        echo "Module '$MODULE' is already installed. Use 'eze $MODULE update' to refresh."
        exit 0
    fi
    mkdir -p "$module_path"
fi

# -------------------------------
# Download module
# -------------------------------
slow_download "$GITHUB_RAW" "$module_path/$MODULE"
