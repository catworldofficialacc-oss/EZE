#!/bin/bash
# eze0.2.2 — Ez installer/updater with visual self-update
# Supports: EzCore, Keys, Musical, Audio
# Downloads slowly line by line for visual effect

# -------------------------------
# Paths
# -------------------------------
EZ_HOME="$HOME/ez_runtime"
MODULES_DIR="$EZ_HOME/modules"
EZ_CORE="$EZ_HOME/ez"
mkdir -p "$MODULES_DIR"

# -------------------------------
# Map modules to raw GitHub URLs
# -------------------------------
declare -A MODULE_URLS
MODULE_URLS["EzCore"]="https://raw.githubusercontent.com/catworldofficialacc-oss/EzCode/refs/heads/main/Ez"
MODULE_URLS["Keys"]="https://raw.githubusercontent.com/catworldofficialacc-oss/EZK/refs/heads/main/Keys0.2.0"
MODULE_URLS["Musical"]="https://raw.githubusercontent.com/catworldofficialacc-oss/EZM/refs/heads/main/Musical"
MODULE_URLS["Audio"]="https://raw.githubusercontent.com/catworldofficialacc-oss/EZA/refs/heads/main/Audio"

# -------------------------------
# Slow line-by-line downloader
# -------------------------------
slow_download() {
    local url="$1"
    local dest="$2"

    temp=$(mktemp)
    if command -v curl &> /dev/null; then
        curl -s -L -o "$temp" "$url"
    elif command -v wget &> /dev/null; then
        wget -q -O "$temp" "$url"
    else
        echo "Error: curl or wget not installed"
        exit 1
    fi

    mkdir -p "$(dirname "$dest")"
    > "$dest"
    echo "Downloading $dest..."
    while IFS= read -r line; do
        echo "$line" >> "$dest"
        # Print slowly for visual effect
        for (( i=0; i<${#line}; i++ )); do
            printf "%c" "${line:$i:1}"
            sleep 0.005
        done
        echo ""
    done < "$temp"

    rm "$temp"
    echo "Download complete ✅"
}

# -------------------------------
# Self-update handling for eze1
# -------------------------------
if [[ "$(basename "$0")" == "eze1" ]]; then
    echo "Finalizing self-update..."
    mv "$0" "$EZ_CORE"
    chmod +x "$EZ_CORE"
    echo "Ez installer updated successfully! ✅"
    exit 0
fi

# -------------------------------
# CLI Arguments
# -------------------------------
MODULE="$1"
ACTION="$2"

if [[ -z "$MODULE" ]]; then
    echo "Ez Installer (eze0.2.2)"
    echo "Available modules:"
    for m in "${!MODULE_URLS[@]}"; do
        echo "  - $m"
    done
    echo ""
    echo "Usage: eze <EzCore|Keys|Musical|Audio> [update|remove|selfupdate]"
    exit 0
fi

# -------------------------------
# Self-update
# -------------------------------
if [[ "$MODULE" == "selfupdate" ]]; then
    echo "Starting Ez self-update..."
    tmpfile="$EZ_HOME/eze1"
    slow_download "${MODULE_URLS["EzCore"]}" "$tmpfile"
    chmod +x "$tmpfile"
    echo "Launching eze1 to finalize update..."
    "$tmpfile" &
    exit 0
fi

# -------------------------------
# Check module exists
# -------------------------------
RAW_URL="${MODULE_URLS[$MODULE]}"
if [[ -z "$RAW_URL" ]]; then
    echo "Unknown module: $MODULE"
    echo "Available: ${!MODULE_URLS[@]}"
    exit 1
fi

module_path="$MODULES_DIR/$MODULE"

# -------------------------------
# Remove
# -------------------------------
if [[ "$ACTION" == "remove" ]]; then
    if [[ -d "$module_path" ]]; then
        rm -rf "$module_path"
        echo "Module '$MODULE' removed ❌"
    else
        echo "Module '$MODULE' is not installed."
    fi
    exit 0
fi

# -------------------------------
# Update
# -------------------------------
if [[ "$ACTION" == "update" ]]; then
    if [[ ! -d "$module_path" ]]; then
        echo "Not installed. Run 'eze $MODULE' first."
        exit 1
    fi
    rm -rf "$module_path"/*
    mkdir -p "$module_path"
fi

# -------------------------------
# Default: install
# -------------------------------
if [[ "$ACTION" != "update" ]]; then
    if [[ -d "$module_path" && "$ACTION" != "" ]]; then
        echo "Already installed. Use 'eze $MODULE update'."
        exit 0
    fi
    mkdir -p "$module_path"
fi

# -------------------------------
# Do the download
# -------------------------------
slow_download "$RAW_URL" "$module_path/$MODULE"
chmod +x "$module_path/$MODULE"
echo "Module '$MODULE' installed/updated successfully ✅"
